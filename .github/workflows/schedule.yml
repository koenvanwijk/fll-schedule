name: FLL Tournament Scheduler

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Maakt handmatig starten mogelijk via UI of API
    inputs:
      num_teams:
        description: 'Aantal teams (10-40)'
        required: true
        default: '40'
        type: string
      num_tables:
        description: 'Aantal tafels (4-10)'
        required: true
        default: '6'
        type: string
      num_jury_rooms:
        description: 'Aantal jury rooms (4-10)'
        required: true
        default: '8'
        type: string
      matches_per_team:
        description: 'Wedstrijden per team'
        required: true
        default: '4'
        type: string
      num_timeslots:
        description: 'Aantal tijdsloten'
        required: true
        default: '40'
        type: string
      start_time:
        description: 'Start tijd (HH:MM)'
        required: true
        default: '09:30'
        type: string
      match_duration:
        description: 'Wedstrijd duur (minuten)'
        required: true
        default: '7'
        type: string
      jury_duration:
        description: 'Jury sessie duur (minuten)'
        required: true
        default: '42'
        type: string
      buffer_time:
        description: 'Minimale buffer tijd (minuten)'
        required: true
        default: '30'
        type: string
      break_enabled:
        description: 'Pauze inschakelen (Ja/Nee)'
        required: true
        default: 'Ja'
        type: choice
        options:
          - 'Ja'
          - 'Nee'
      break_start_time:
        description: 'Pauze start tijd (minuten)'
        required: true
        default: '168'
        type: string
      break_duration:
        description: 'Pauze duur (minuten)'
        required: true
        default: '35'
        type: string

jobs:
  generate-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ortools numpy pandas
    
    - name: Run scheduler
      run: |
        python run_scheduler_with_params.py \
          --num-teams "${{ github.event.inputs.num_teams || '40' }}" \
          --num-tables "${{ github.event.inputs.num_tables || '6' }}" \
          --num-jury-rooms "${{ github.event.inputs.num_jury_rooms || '8' }}" \
          --matches-per-team "${{ github.event.inputs.matches_per_team || '4' }}" \
          --num-timeslots "${{ github.event.inputs.num_timeslots || '40' }}" \
          --start-time "${{ github.event.inputs.start_time || '09:30' }}" \
          --match-duration "${{ github.event.inputs.match_duration || '7' }}" \
          --jury-duration "${{ github.event.inputs.jury_duration || '42' }}" \
          --buffer-time "${{ github.event.inputs.buffer_time || '30' }}" \
          --break-enabled "${{ github.event.inputs.break_enabled || 'Ja' }}" \
          --break-start-time "${{ github.event.inputs.break_start_time || '168' }}" \
          --break-duration "${{ github.event.inputs.break_duration || '35' }}"
      continue-on-error: false
    
    - name: Find generated schedule
      id: find_schedule
      run: |
        SCHEDULE_FILE=$(ls -t schedule-complete-*.json | head -1)
        echo "schedule_file=$SCHEDULE_FILE" >> $GITHUB_OUTPUT
        echo "Found schedule: $SCHEDULE_FILE"
    
    - name: Run tests
      run: |
        python test_schedule.py ${{ steps.find_schedule.outputs.schedule_file }}
    
    - name: Upload schedule artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: fll-schedule
        path: schedule-complete-*.json
        retention-days: 30
    
    - name: Display schedule summary
      if: success()
      run: |
        echo "âœ… Schedule generated successfully!"
        python -c "
        import json
        import sys
        
        schedule_file = '${{ steps.find_schedule.outputs.schedule_file }}'
        with open(schedule_file, 'r') as f:
            data = json.load(f)
        
        print('\nðŸ“Š SCHEDULE SUMMARY')
        print('=' * 60)
        print(f'Teams: {len(data[\"teamList\"])}')
        print(f'Tables: {len(data[\"tableList\"])}')
        print(f'Jury Rooms: {len(data[\"juryList\"])}')
        print(f'Total Matches: {len(data[\"teamTableAllocationList\"])}')
        print(f'Total Jury Sessions: {len(data[\"teamJuryAllocationList\"])}')
        print('=' * 60)
        "
